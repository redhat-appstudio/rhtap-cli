{{- define "rhtap-dh.app-conf" }}
app:
  title: Red Hat Developer Hub
  baseUrl: ${BACKEND_URL}
# Lookup for all the required secrets
{{- $argocdSecretObj := (lookup "v1" "Secret" .Release.Namespace "rhtap-argocd-integration") }}
{{- $argocdSecretData := ($argocdSecretObj.data | default dict) }}
{{- $bbSecretObj := (lookup "v1" "Secret" .Release.Namespace "rhtap-bitbucket-integration") }}
{{- $ghSecretObj := (lookup "v1" "Secret" .Release.Namespace "rhtap-github-integration") }}
{{- $gitlabSecretObj := (lookup "v1" "Secret" .Release.Namespace "rhtap-gitlab-integration") }}
{{- $jenkinsSecretObj := (lookup "v1" "Secret" .Release.Namespace "rhtap-jenkins-integration") }}
{{- $quaySecretObj := (lookup "v1" "Secret" .Release.Namespace "rhtap-quay-integration") }}
{{- $quaySecretData := ($quaySecretObj.data | default dict) }}
{{- $nexusSecretObj := (lookup "v1" "Secret" .Release.Namespace "rhtap-nexus-integration") }}
{{- $artifactorySecretObj := (lookup "v1" "Secret" .Release.Namespace "rhtap-artifactory-integration") }}
{{- $artifactorySecretData := ($artifactorySecretObj.data | default dict) }}

{{- if $argocdSecretData }}
argocd:
  appLocatorMethods:
    - instances:
        - name: default
          url: ${ARGOCD__URL}
          token: ${ARGOCD__API_TOKEN}
      type: 'config'
  password: ${ARGOCD__PASSWORD}
  username: ${ARGOCD__USER}
  waitCycles: 25
{{- end }}
{{- if $artifactorySecretObj }}
artifactory:
  uiUrl: ${ARTIFACTORY__URL}
{{- end }}
auth:
  environment: production
  providers:
  {{- $signInPage := "" }}
  {{- $ghSecretObj := (lookup "v1" "Secret" .Release.Namespace "rhtap-github-integration") }}
  {{- if $ghSecretObj }}
    {{- $signInPage = "github" }}
    github:
      production:
        clientId: ${GITHUB__APP__CLIENT__ID}
        clientSecret: ${GITHUB__APP__CLIENT__SECRET}
      {{- if ne ($ghSecretObj.data.host | b64dec) "github.com" }}
        enterpriseInstanceUrl: ${GITHUB__URL}
      {{- end }}
  {{- end }}
  {{- $glSecretObj := (lookup "v1" "Secret" .Release.Namespace "rhtap-gitlab-integration") }}
  {{- $glSecretData := ($glSecretObj.data | default dict) }}
  {{- if $glSecretData }}
    {{- if and $glSecretData.clientId $glSecretData.clientSecret }}
    {{- $signInPage = "gitlab" }}
    gitlab:
      production:
      {{- if ne ($glSecretData.host | b64dec) "gitlab.com" }}
        audience: ${GITLAB__URL}
      {{- end }}
        clientId: ${GITLAB__APP__CLIENT__ID}
        clientSecret: ${GITLAB__APP__CLIENT__SECRET}
    {{- end }}
  {{- end }}
backend:
  auth:
    keys:
      - secret: ${BACKEND_SECRET}
  {{- if .Values.debug.ci }}
    dangerouslyDisableDefaultAuthPolicy: true
  {{- end }}
  baseUrl: ${BACKEND_URL}
  cors:
    origin: ${BACKEND_URL}
catalog:
  locations:
    - target: ${DEVELOPER_HUB__CATALOG__URL}
      type: url
  rules:
    - allow:
      - Component
      - System
      - Group
      - Resource
      - Location
      - Template
      - API
dangerouslyAllowSignInWithoutUserInCatalog: true
integrations:
{{- if $bbSecretObj }}
  bitbucketCloud:
    - appPassword: ${BITBUCKET__APP_PASSWORD}
      username: ${BITBUCKET__USERNAME}
{{- end }}
{{- if $ghSecretObj }}
  github:
    - host: ${GITHUB__HOST}
      token: ${GITHUB__TOKEN}
      apps:
        - appId: ${GITHUB__APP__ID}
          clientId: ${GITHUB__APP__CLIENT__ID}
          clientSecret: ${GITHUB__APP__CLIENT__SECRET}
          webhookUrl: ${GITHUB__APP__WEBHOOK__URL}
          webhookSecret: ${GITHUB__APP__WEBHOOK__SECRET}
          privateKey: ${GITHUB__APP__PRIVATE_KEY}
{{- end }}
{{- if $gitlabSecretObj }}
  gitlab:
    - host: ${GITLAB__HOST}
      apiBaseUrl: https://${GITLAB__HOST}/api/v4
      token: ${GITLAB__TOKEN}
{{- end }}
{{- if (lookup "v1" "Secret" .Release.Namespace "rhtap-jenkins-integration") }}
jenkins:
  instances:
    - name: default
      apiKey: ${JENKINS__TOKEN}
      baseUrl: ${JENKINS__BASEURL}
      username: ${JENKINS__USERNAME}
{{- end }}
{{- if $nexusSecretObj }}
nexus:
  uiUrl: ${NEXUS__URL}
{{- end }}
permission:
  # Disable RBACs
  enabled: false
proxy:
  endpoints:
  {{- if $artifactorySecretObj }}
    '/jfrog-artifactory/api':
      target: ${ARTIFACTORY__URL}
      headers:
      {{- if $artifactorySecretData.token }}
        Authorization: 'Bearer ${ARTIFACTORY__API_TOKEN}'
      {{- end }}
      # Change to "false" in case of using self hosted artifactory instance with a self-signed certificate
      secure: true
  {{- end }}
  {{- if $nexusSecretObj }}
    '/nexus-repository-manager':
      target: ${NEXUS__URL}
      headers:
        X-Requested-With: 'XMLHttpRequest'
      changeOrigin: true
      secure: true
  {{- end }}
  {{- if $quaySecretObj }}
    '/quay/api':
      target: ${QUAY__URL}
      changeOrigin: true
      headers:
        X-Requested-With: 'XMLHttpRequest'
      {{- if $quaySecretData.token }}
        Authorization: 'Bearer ${QUAY__API_TOKEN}'
      {{- end }}
      # Change to "false" in case of using self hosted quay instance with a self-signed certificate
      secure: true
  {{- end }}
{{- if $quaySecretObj }}
quay:
  uiUrl: ${QUAY__URL}
{{- end }}
{{- if $signInPage }}
signInPage: {{ $signInPage }}
{{- end }}
techdocs:
  builder: 'local'
  generator:
    runIn: 'local'
  publisher:
    type: 'local'
{{- end }}
